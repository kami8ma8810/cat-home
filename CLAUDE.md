# cat-home プロジェクト

## 概要

日本にある猫飼育可能な賃貸物件をアーカイブ・検索できるサービス。

## 技術スタック

| レイヤー | 技術 |
|---------|------|
| フロントエンド | Nuxt 4 + Nuxt UI v4 + Pinia |
| バックエンド | Supabase (PostgreSQL + Edge Functions) |
| ホスティング | Cloudflare Pages |
| スクレイピング | GitHub Actions + Cheerio |
| 認証 | Supabase Auth |
| ストレージ | Supabase Storage |
| モノレポ | Turborepo + pnpm workspace |

---

## アーキテクチャ解説

### 全体構成図

```
┌─────────────────────────────────────────────────────────────────┐
│                         ユーザー                                 │
│                    （ブラウザでアクセス）                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Cloudflare Pages                              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                     Nuxt 4 (SSR)                          │  │
│  │                                                           │  │
│  │   【役割】物件データの表示・検索UIの提供                     │  │
│  │   【やらないこと】スクレイピング ❌                          │  │
│  │                                                           │  │
│  │   - 物件一覧ページ                                         │  │
│  │   - 物件検索・フィルタリング                                │  │
│  │   - 物件詳細ページ                                         │  │
│  │   - お気に入り管理                                         │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ Supabase SDK でデータ取得
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                         Supabase                                 │
│  ┌─────────────┬─────────────┬─────────────┬─────────────────┐  │
│  │ PostgreSQL  │ Edge Funcs  │    Auth     │    Storage      │  │
│  │   (DB)      │(サーバーレス)│   (認証)    │  (画像保存)     │  │
│  └─────────────┴─────────────┴─────────────┴─────────────────┘  │
│                                                                  │
│  【役割】データの永続化・API提供・認証                            │
└─────────────────────────────────────────────────────────────────┘
                              ▲
                              │ 定期的にデータを投入
                              │
┌─────────────────────────────────────────────────────────────────┐
│                      GitHub Actions                              │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │                 スクレイピング cron                        │  │
│  │                                                           │  │
│  │   【役割】定期的に物件サイトからデータ収集                   │  │
│  │                                                           │  │
│  │   1. 毎日 AM 3:00 に起動                                   │  │
│  │   2. Supabase Edge Function を呼び出し                     │  │
│  │   3. Edge Function 内で Cheerio でHTMLパース               │  │
│  │   4. 取得データを PostgreSQL に保存                        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

### なぜ Nuxt でスクレイピングしないのか？

| 観点 | Nuxt でスクレイピング ❌ | 分離設計 ✅ |
|------|------------------------|-----------|
| **パフォーマンス** | ユーザーリクエストと競合 | バックグラウンドで独立実行 |
| **セキュリティ** | スクレイピングコードが露出 | 完全に分離 |
| **スケーラビリティ** | サーバー負荷増大 | 独立してスケール可能 |
| **エラー影響** | サイト全体に影響 | スクレイパーだけに限定 |
| **デプロイ** | 全体再デプロイ必要 | スクレイパーだけ更新可能 |

---

## 他のアーキテクチャとの比較

### パターン1: Python スクレイパー（従来型）

```
┌──────────────────┐     ┌──────────────┐     ┌──────────────┐
│  Python Script   │ ──▶ │   DB         │ ◀── │  Frontend    │
│  (requests,      │     │  (PostgreSQL │     │  (React,     │
│   BeautifulSoup) │     │   /SQLite)   │     │   Vue, etc)  │
└──────────────────┘     └──────────────┘     └──────────────┘
    ↑ cron で実行
```

**メリット**:
- 実績豊富（不動産スクレイピングの定番）
- ライブラリが充実（Scrapy, Selenium）
- デバッグしやすい

**デメリット**:
- サーバー運用が必要（VPS等）
- 環境構築が複雑
- 運用コストがかかる

---

### パターン2: サーバーレス（今回の設計）

```
┌──────────────────┐     ┌──────────────┐     ┌──────────────┐
│  GitHub Actions  │ ──▶ │  Supabase    │ ◀── │  Nuxt 4      │
│  + Edge Function │     │  (PostgreSQL │     │  (Cloudflare │
│  + Cheerio       │     │   + Auth)    │     │   Pages)     │
└──────────────────┘     └──────────────┘     └──────────────┘
    ↑ cron で実行
```

**メリット**:
- 💰 完全無料で運用可能
- 🚀 サーバー管理不要
- 🔧 TypeScript で統一（フロント・バック同じ言語）
- 📦 モノレポで一元管理

**デメリット**:
- Edge Function の実行時間制限
- Cheerio では JavaScript 実行が必要なページに対応不可

---

### 比較表

| 項目 | Python スクレイパー | サーバーレス（今回） |
|------|-------------------|-------------------|
| 初期コスト | 🟡 VPS必要 | 🟢 無料 |
| 運用コスト | 🟡 月額発生 | 🟢 無料〜低コスト |
| 学習コスト | 🟡 Python必要 | 🟢 TypeScript統一 |
| スケーラビリティ | 🟡 自前でスケール | 🟢 自動スケール |
| デバッグ | 🟢 しやすい | 🟡 やや難しい |
| JS実行ページ | 🟢 Selenium対応 | 🔴 未対応 |
| 実績 | 🟢 豊富 | 🟡 新しい手法 |

---

### 採用方針: ハイブリッド構成

**基本方針**: TypeScript で始めて、必要なら Python を追加

```
┌────────────────────────────────────────────────────────────┐
│                    GitHub Actions (無料)                    │
│                                                            │
│  Phase 1 (現在)         Phase 2 (必要になったら)            │
│  ┌──────────────────┐   ┌──────────────────────────┐       │
│  │ TypeScript       │   │ Python + Selenium        │       │
│  │ + Cheerio        │   │ (JS実行が必要なサイト)     │       │
│  │                  │   │                          │       │
│  │ 対応: SUUMO等    │   │ 対応: athome等           │       │
│  │ 静的HTMLサイト    │   │ 動的レンダリングサイト     │       │
│  └──────────────────┘   └──────────────────────────┘       │
│            │                       │                       │
│            └───────────┬───────────┘                       │
│                        ▼                                   │
│                  Supabase DB                               │
└────────────────────────────────────────────────────────────┘
```

**この方針のメリット**:
- 💰 両方とも GitHub Actions で実行すれば無料
- 📦 TypeScript は モノレポで型共有できる
- 🔧 Python は必要になってから追加（YAGNI原則）
- 🎯 SUUMOなど主要サイトは TypeScript + Cheerio で十分

## ディレクトリ構造

```
cat-home/
├── apps/
│   └── web/                    # Nuxt 4 アプリ
├── packages/
│   ├── shared/                 # 共有型定義
│   └── scraper/                # スクレイパーロジック
├── supabase/
│   ├── functions/              # Edge Functions
│   └── migrations/             # DBマイグレーション
└── .github/workflows/          # GitHub Actions
```

## パッケージ構成

- `@cat-home/web` - Nuxt 4 フロントエンド
- `@cat-home/shared` - 共有型定義（Property, SearchParams など）
- `@cat-home/scraper` - スクレイピングロジック

## プロジェクト固有のルール

グローバル設定（`~/.claude/CLAUDE.md`）を継承。

### 追加ルール

- スクレイピングは `packages/scraper` で実装
- 型定義は `packages/shared` で一元管理
- Supabase のマイグレーションは `supabase/migrations` で管理
- Edge Functions は `supabase/functions` で実装

### UI ガイドライン

- **絵文字は使用しない**: UI で絵文字（例: 🐱, 🏠）を使用せず、アイコンライブラリを使用する
  - 推奨: Heroicons（`i-heroicons-*`）、Lucide（`i-lucide-*`）
  - Iconify 経由で `<UIcon name="i-heroicons-home" />` のように使用
  - 参考: https://ui.nuxt.com/getting-started/icons
